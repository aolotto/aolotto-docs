# 😄 抽奖

aolotto抽奖过程完全由算法自动执行，无人为干预，定时触发器每间隔2分钟检测当前轮次状态，满足开奖条件后，自动切换到下一轮次，满足条件自动结束并切换到下一轮次，否则当前轮次继续进行：

1. **间隔时间≥24小时**，触发时间比对轮次启动时间大于等于24小时，则满足轮次结束的时间条件；
2. **用户投注金额≥基础奖金**，启动当前轮次时会将上一轮次的50%奖池余额计入为基础奖金，当前轮次所有用户的累积投注金额大于或等于基础奖金，则满足参与度条件；
3. 如间隔时间**≥168小时当前轮次累积投注量仍然小雨奖池中的基础奖金，当前轮次强行取消并自动退还用户的投注金，基础奖金放入下一轮次。**

#### 2.1 轮次切换通知

轮次结束后，将向所有用户下发轮次切换通知Round-Notice,  若轮次为强行取消，参与者还会收到相应的退款通知；

#### 2.2 幸运号码

轮次结束后的第5个区块高度上开奖并生成幸运号码，幸运号码基于Issac Cipher的随机数函数生成，使用开奖区块的Hash值, 轮次累积投注人数以及数量等无法提前预知因子作为随机函数的种子输入，保证幸运号码生成具有随机性，可验证性和不可预测性：

1. 不可预测性：Arweave的区块Hash是基于区块全部交易内容生成的唯一性ID，采用轮次结束后的第5个区块的hash，意味着任何人在下注期间完全无法预知开奖算法的种子。
2. 可验证性：issac cipher的随机数函数在种子确定的情况下生成的结果也是确定的，意味着通过CU节点生成的幸运号码可被验证，规避CU（计算单元）节点在执行中进行黑箱操作的可能性；
3. 取值分布的随机性：3位数号码并非一次性生成，而是逐位调用随机函数，将统一的种子和位置编号作为输入，分别生成0-9之间的随机数值，保证了3位数号码取值分布的随机性。

<details>

<summary>幸运号码生成算法示例</summary>

```lua
local seed = Block.Hash..Round.TotalBets..Round.Participator

local getLuckyNumber = function(seed,len)
  local numbers = ""
  for i = 1, len or 3 do
    local n = crypto.cipher.issac.random(0, 9, tostring(i)..seed..numbers)
    numbers = numbers .. n
  end
  return numbers
end

local luckyNumber = getLuckyNumber(seed,3)
```

</details>

#### 2.3 奖金下发

所有中奖的投注将会均分轮次中奖池总额的50%，轮次进行中支持赞助者添加额外的奖金赞助，赞助部分全额计入到本轮奖金中。奖金总额=(奖池基础奖金+用户投注金额)\*0.5 + 赞助金，参与者地址按照中奖投注于总量的占比均分, 中奖者将会在开奖之后，收到又系统下发的\`Reward-Notice\`。
